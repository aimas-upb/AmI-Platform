from fabric.api import task, env, run, local
from jinja2 import Template
import string
import os


def get_services():
    """ Returns the set of already defined services. """
    with open("services.txt") as f:
        services = [line[:-1] for line in f.readlines()]
        return filter(lambda x: len(x) > 0, services)


def service_already_exists(name):
    """ Check if a service with the given name already exists. """
    return name in set(get_services())


def default_file_name(name):
    """ Given a service name, provide a good default for a file name. """
    if name.startswith('ami-'):
        return 'pipeline/' + name[4:] + '.py'
    else:
        return 'pipeline/' + name + '.py'


def default_queue_name(name):
    """ Given a service name, provide a good default for a queue name. """
    if name.startswith('ami-'):
        return name[4:]
    else:
        return name


def default_class_name(name):
    """ Given a service name, provide a good default for a class name. """
    if name.startswith('ami-'):
        dashed_name = name[4:]
    else:
        dashed_name = name
    return string.capwords(dashed_name.replace('-', ' ')).replace(' ', '')


def render_template(template_file, context, target_file):
    """ Renders a template to a given destination file, given context vars. """
    with open(template_file, 'rt') as src:
        content = ''.join(src.readlines())
        jinja_template = Template(content)
        output = jinja_template.render(**context)
        with open(target_file, 'wt') as dest:
            dest.write(output)


@task
def new_service(name, file=None, queue=None, class_name=None):
    """ Installs a new service with the given name. """

    if service_already_exists(name):
        print "A service with the name %s already exists." % name
        return

    file = file or default_file_name(name)
    queue = queue or default_queue_name(name)
    class_name = class_name or default_class_name(name)

    context = {
        'service_class_name': class_name,
        'service_queue': queue,
        'service_name': name,
        'service_file': file,
        'service_description': '%s service for AmI Lab' % class_name
    }

    # Generate dumb code file
    print "Generating code file %s" % file
    render_template('admin/templates/service-code.py',
                    context,
                    file)

    # Generate monit script - make sure that the service is never down
    print "Generating monit script scripts/monit/%s" % name
    render_template('admin/templates/service-monit',
                    context,
                    'scripts/monit/%s' % name)

    # Generate upstart script - make it a system service
    print "Generating upstart script scripts/upstart/%s.conf" % name
    render_template('admin/templates/service-upstart',
                    context,
                    'scripts/upstart/%s.conf' % name)

    # Generate shell script that runs it + make it executable
    print "Generating shell that runs the service scripts/shell/%s.sh" % name
    render_template('admin/templates/service-shell',
                    context,
                    'scripts/shell/%s.sh' % name)
    os.chmod('scripts/shell/%s.sh' % name, 0755)

    # Append service name to services.txt
    services = get_services()
    services.append(name)
    services.append('')
    with open('services.txt', 'wt') as f:
        f.write('\n'.join(services))

DAQ_HOSTS = ['ami-daq-01.local', 'ami-daq-03.local',
             'ami-daq-04.local', 'ami-daq-05.local']


@task
def copy_pub_key_to_daq():
    """Copy public ssh key to all data acquisition hosts."""
    for host in DAQ_HOSTS:
        local("cat ~/.ssh/id_rsa.pub | ssh %s@%s 'cat >> .ssh/authorized_keys'"
              % ('ami', host))


@task
def stop_daq():
    """Stops all data acquisition hosts."""
    for host in DAQ_HOSTS:
        run('ssh ami@%s; cd ~/AmI-Platform/; ./stop.py' % host)

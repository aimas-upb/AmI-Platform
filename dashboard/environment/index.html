<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Start Bootstrap - SB Admin Version 2.0 Demo</title>

    <!-- Core CSS - Include with every page -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">

    <!-- SB Admin CSS - Include with every page -->
    <link href="css/sb-admin.css" rel="stylesheet">

</head>

<body>

    <div id="wrapper">

        <nav class="navbar navbar-default navbar-fixed-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">

                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">AmI-Lab Dashboard</a>
            </div>
            <!-- /.navbar-header -->

            <div class="navbar-default navbar-static-side" role="navigation">
                <div class="sidebar-collapse">
                    <ul class="nav" id="side-menu">
                        <!-- <li class="sidebar-search">
                            <div class="input-group custom-search-form">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="input-group-btn">
                                <button class="btn btn-default" type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                            </div>
                            
                        </li> -->
                        <li>
                            <a href="index.html"><i class="fa fa-dashboard fa-fw"></i> Live</a>
                        </li>
                        <!--
                        <li>
                            <a href="#"><i class="fa fa-bar-chart-o fa-fw"></i> Charts<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="flot.html">Flot Charts</a>
                                </li>
                                <li>
                                    <a href="morris.html">Morris.js Charts</a>
                                </li>
                            </ul>
                        </li>

                        <li>
                            <a href="tables.html"><i class="fa fa-table fa-fw"></i> Tables</a>
                        </li>
                        <li>
                            <a href="forms.html"><i class="fa fa-edit fa-fw"></i> Forms</a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-wrench fa-fw"></i> UI Elements<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="panels-wells.html">Panels and Wells</a>
                                </li>
                                <li>
                                    <a href="buttons.html">Buttons</a>
                                </li>
                                <li>
                                    <a href="notifications.html">Notifications</a>
                                </li>
                                <li>
                                    <a href="typography.html">Typography</a>
                                </li>
                                <li>
                                    <a href="grid.html">Grid</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-sitemap fa-fw"></i> Multi-Level Dropdown<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="#">Second Level Item</a>
                                </li>
                                <li>
                                    <a href="#">Second Level Item</a>
                                </li>
                                <li>
                                    <a href="#">Third Level <span class="fa arrow"></span></a>
                                    <ul class="nav nav-third-level">
                                        <li>
                                            <a href="#">Third Level Item</a>
                                        </li>
                                        <li>
                                            <a href="#">Third Level Item</a>
                                        </li>
                                        <li>
                                            <a href="#">Third Level Item</a>
                                        </li>
                                        <li>
                                            <a href="#">Third Level Item</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-files-o fa-fw"></i> Sample Pages<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="blank.html">Blank Page</a>
                                </li>
                                <li>
                                    <a href="login.html">Login Page</a>
                                </li>
                            </ul>
                        </li>
                        -->
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">AmI-Lab Live Data</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-bar-chart-o fa-fw"></i> Environment - Temperature (&deg;C)
                            <div class="dropdown navbar-right">
                                    <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                                    	<i class="fa fa-cogs fa-fw"></i>
                                        Select Sensors
                                        <span class="caret"></span>
                                    </button>
                                    <ul id="tempSensorGroup" class="dropdown-menu dropdown-messages">
                                        <li name="TOGGLE"><a href="#"><i class="fa fa-square-o fa-fw"></i>All sensors</a></li>
                                        <li class="divider"></li>
                                        <li name="K1-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K1-A</a></li>
                                        <li name="K1-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K1-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K2-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-A</a></li>
                                        <li name="K2-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-B</a></li>
                                        <li name="K2-C"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-C</a></li>
                                        <li class="divider"></li>
                                        <li name="K3-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K3-A</a></li>
                                        <li name="K3-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K3-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K4-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K4-A</a></li>
                                        <li name="K4-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K4-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K5-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K5-A</a></li>
                                        <li name="K5-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K5-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K6-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K6-A</a></li>
                                        <li name="K6-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K6-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K7-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-A</a></li>
                                        <li name="K7-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-B</a></li>
                                        <li name="K7-C"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-C</a></li>
                                        <li class="divider"></li>
                                        <li name="K8-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K8-A</a></li>
                                        <li class="divider"></li>
                                        <li name="K9-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K9-A</a></li>
                                        <li name="K9-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K9-B</a></li>
                                    </ul>
                            </div>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="flot-chart">
                                <div class="flot-chart-content" id="temp-chart"></div>
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>  
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-bar-chart-o fa-fw"></i> Environment - Humidity (%)
                            <div class="dropdown navbar-right">
                                    <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                                        <i class="fa fa-cogs fa-fw"></i>
                                        Select Sensors
                                        <span class="caret"></span>
                                    </button>
                                    <ul id="humidSensorGroup" class="dropdown-menu dropdown-messages">
                                        <li name="TOGGLE"><a href="#"><i class="fa fa-square-o fa-fw"></i>All sensors</a></li>
                                        <li class="divider"></li>
                                        <li name="K1-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K1-A</a></li>
                                        <li name="K1-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K1-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K2-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-A</a></li>
                                        <li name="K2-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-B</a></li>
                                        <li name="K2-C"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-C</a></li>
                                        <li class="divider"></li>
                                        <li name="K3-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K3-A</a></li>
                                        <li name="K3-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K3-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K4-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K4-A</a></li>
                                        <li name="K4-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K4-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K5-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K5-A</a></li>
                                        <li name="K5-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K5-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K6-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K6-A</a></li>
                                        <li name="K6-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K6-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K7-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-A</a></li>
                                        <li name="K7-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-B</a></li>
                                        <li name="K7-C"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-C</a></li>
                                        <li class="divider"></li>
                                        <li name="K8-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K8-A</a></li>
                                        <li class="divider"></li>
                                        <li name="K9-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K9-A</a></li>
                                        <li name="K9-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K9-B</a></li>
                                    </ul>
                            </div>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="flot-chart">
                                <div class="flot-chart-content" id="humid-chart"></div>
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>  
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-bar-chart-o fa-fw"></i> Environment - Luminosity (?)
                            <div class="dropdown navbar-right">
                                    <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                                        <i class="fa fa-cogs fa-fw"></i>
                                        Select Sensors
                                        <span class="caret"></span>
                                    </button>
                                    <ul id="lumSensorGroup" class="dropdown-menu dropdown-messages">
                                        <li name="TOGGLE"><a href="#"><i class="fa fa-square-o fa-fw"></i>All sensors</a></li>
                                        <li class="divider"></li>
                                        <li name="K1-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K1-A</a></li>
                                        <li name="K1-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K1-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K2-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-A</a></li>
                                        <li name="K2-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-B</a></li>
                                        <li name="K2-C"><a href="#"><i class="fa fa-square-o fa-fw"></i>K2-C</a></li>
                                        <li class="divider"></li>
                                        <li name="K3-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K3-A</a></li>
                                        <li name="K3-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K3-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K4-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K4-A</a></li>
                                        <li name="K4-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K4-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K5-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K5-A</a></li>
                                        <li name="K5-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K5-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K6-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K6-A</a></li>
                                        <li name="K6-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K6-B</a></li>
                                        <li class="divider"></li>
                                        <li name="K7-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-A</a></li>
                                        <li name="K7-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-B</a></li>
                                        <li name="K7-C"><a href="#"><i class="fa fa-square-o fa-fw"></i>K7-C</a></li>
                                        <li class="divider"></li>
                                        <li name="K8-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K8-A</a></li>
                                        <li class="divider"></li>
                                        <li name="K9-A"><a href="#"><i class="fa fa-square-o fa-fw"></i>K9-A</a></li>
                                        <li name="K9-B"><a href="#"><i class="fa fa-square-o fa-fw"></i>K9-B</a></li>
                                    </ul>
                            </div>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="flot-chart">
                                <div class="flot-chart-content" id="lum-chart"></div>
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>  
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- Core Scripts - Include with every page -->
    <script src="js/jquery-1.10.2.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>

    <script src="js/ami-platform-admin.js"></script>

    <script src="js/plugins/flot/jquery.flot.js"></script>
    <script src="js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="js/plugins/flot/jquery.flot.pie.js"></script>
    <script src="js/live/flot-arduino.js"></script>

	<script type="text/javascript">
		// var envSensorBaseUrl = "http://ami-crunch-01.local/api/latest_environment/";
        var envSensorBaseUrl = "http://localhost/environment/data/";

		var defaultSensor = 'K1-A';
		var selectedSensors = [];

		var envSensorIds = ['K1-A','K1-B','K2-A','K2-B','K2-C','K3-A','K3-B','K4-A','K4-B','K5-A','K5-B','K6-A','K6-B','K7-A','K7-B','K7-C','K8-A','K9-A','K9-B'];

		var temperatureData = {};
		var humidityData = {};
		var luminosityData = {};
		var distanceData = {};

        var maximumSpan = 50000;

        var tempSensorGroup = $("ul#tempSensorGroup");
        var humidSensorGroup = $("ul#humidSensorGroup");
        var lumSensorGroup = $("ul#lumSensorGroup");
        var allSensorGroup = tempSensorGroup.add(humidSensorGroup.add(lumSensorGroup));

        var allSensorsToggle = false;

		$('li',allSensorGroup).on('click',function (e) {
            console.log("[INFO] Target text: " + $(e.target).text());
            if($(e.target).text() == "All sensors") {
                console.log("[INFO] All sensors selected");
                if(allSensorsToggle == false) {
                    for(envSensorId in envSensorIds) {
                        if($.inArray(envSensorIds[envSensorId],selectedSensors) == -1)
                            toggleSensorButtons(envSensorIds[envSensorId]);
                    }
                    allSensorsToggle = true;
                    $("i",$(e.target)).removeClass("fa-square-o").addClass("fa-check-square-o");
                } else {

                    for(envSensorId in envSensorIds) {
                            toggleSensorButtons(envSensorIds[envSensorId]);
                    }
                    allSensorsToggle = false;
                    selectedSensors = [];
                    $("i",$(e.target)).removeClass("fa-check-square-o").addClass("fa-square-o");
                }
            } else {
                sensorId = $(e.target).text();
                toggleSensorButtons(sensorId);
            }

			if(selectedSensors.length == 0) {
                toggleSensorButtons(defaultSensor);
			}

            plotChart(temperatureData,selectedSensors,"#temp-chart");
            plotChart(humidityData,selectedSensors,"#humid-chart");
            plotChart(luminosityData,selectedSensors,"#lum-chart");
		});

        function toggleSensorButtons(sensorId) {
            sensorIdx = selectedSensors.indexOf(sensorId);
            var sensorButtons = $('li[name="'+sensorId+'"]');
            if(sensorIdx == -1) {
                selectedSensors.push(sensorId);
                for(var i = 0; i < sensorButtons.length; i++) {
                    $("i",$(sensorButtons[i])).removeClass("fa-square-o").addClass("fa-check-square-o");
                }
            } else {
                selectedSensors.splice(sensorIdx,1);
                for(var i = 0; i < sensorButtons.length; i++) {
                    $("i",$(sensorButtons[i])).removeClass("fa-check-square-o").addClass("fa-square-o");
                }
            }
        }

        var customSort = function(array) {
          var len = array.length;
          if(len < 2) { 
            return array;
          }
          var pivot = Math.ceil(len/2);
          return merge(customSort(array.slice(0,pivot)), customSort(array.slice(pivot)));
        };

        var merge = function(left, right) {
          var result = [];
          while((left.length > 0) && (right.length > 0)) {
            if(left[0]["obj"] > right[0]["obj"]) {
              result.push(left.shift());
            }
            else {
              result.push(right.shift());
            }
          }

          result = result.concat(left, right);
          return result;
        };


		function getEnvData() {
			console.log("[INFO] Retrieving data");
            temperatureData = {};
            humidityData = {};
            luminosityData = {};
            getEnvData();

            var callCounter = envSensorIds.length;
            var succededSensorIds = [];

			for (envSensorId in envSensorIds) {
				// console.log("[INFO] GET data for " + envSensorIds[envSensorId]);
				var processEnvFor = function (sensorId) { 
										return function (data) { 
											succededSensorIds.push(sensorId);
                                            processEnvData(data,sensorId);
										};
									};
				$.ajax({
					type: "GET",
					url: envSensorBaseUrl + envSensorIds[envSensorId],
					dataType: "JSON",
					success: processEnvFor(envSensorIds[envSensorId]),
					error: function() {
						console.log("[ERROR] Unable to get data from Dashboard API for " + envSensorId);
                        --callCounter;
					}
				}).done(function() {
                    if(--callCounter == 0) {
                        console.log("[INFO] Loading data into charts");
                        for (succId in succededSensorIds) {
                            temperatureData[succededSensorIds[succId]] = customSort(temperatureData[succededSensorIds[succId]]);
                            humidityData[succededSensorIds[succId]] = customSort(humidityData[succededSensorIds[succId]]);
                            luminosityData[succededSensorIds[succId]] = customSort(luminosityData[succededSensorIds[succId]]);
                        }

                        if(selectedSensors.length == 0)
                            toggleSensorButtons(defaultSensor);
                        
                        plotChart(temperatureData,selectedSensors,"#temp-chart");
                        plotChart(humidityData,selectedSensors,"#humid-chart");
                        plotChart(luminosityData,selectedSensors,"#lum-chart");

                        callCounter = envSensorIds.length;
                        setTimeout(getEnvData,5000);
                    }
                });
			}
		}

		function processEnvData(data, sensorId) {
			if (data != null && data.data != null && data.data != "") {
				// console.log("[INFO] Parsing " + data.data.length + " records for " + sensorId);
				for (var i = 0; i < data.data.length; i++) {
					var currentRecord = $.parseJSON(data.data[i]);
					
                    // create temperature array for the given sensor (if it doesn't exist)
                    if(temperatureData[sensorId] == null) {
						temperatureData[sensorId] = [];
					}
                    // add temperature data measurement
					temperatureData[sensorId].push([currentRecord["created_at"],currentRecord["temperature"]]);

                    // create humidity array for the given sensor (if it doesn't exist)
                    if(humidityData[sensorId] == null) {
                        humidityData[sensorId] = [];
                    }
                    // add humidity data measurement
                    humidityData[sensorId].push([currentRecord["created_at"],currentRecord["humidity"]]);

                    // create luminosity array for the given sensor (if it doesn't exist)
                    if(luminosityData[sensorId] == null) {
                        luminosityData[sensorId] = [];
                    }
                    // add luminosity data measurement
                    luminosityData[sensorId].push([currentRecord["created_at"],currentRecord["luminosity"]]);

                    data = [];
				}
			} else {
                console.log("[WARN] Null data for " + sensorId);
                temperatureData[sensorId] = [];
                humidityData[sensorId] = [];
                luminosityData[sensorId] = [];
            }
		}

        getEnvData();
        // setInterval(function () { 
        //         temperatureData = {};
        //         humidityData = {};
        //         luminosityData = {};
        //         getEnvData();
        //     },
        //     5000);        
	</script>

</body>

</html>
